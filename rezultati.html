<!DOCTYPE html>
<html lang="en" dir="ltr">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
    <title></title>
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css">
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
    <link rel="stylesheet" href="view.css">
    <link rel="manifest" href="manifest.json">
    <script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/js/bootstrap.min.js"></script>
  </head>
  <body  class="text-center">
    <nav class="navbar navbar-default navbar-fixed-top">
		<div class="container-fluid">
      <ul class="nav navbar-nav navbar-left">
        <li><h2 id="podaci"><span class="glyphicon glyphicon-education"></span></h2></li>
			</ul>
      <ul class="nav navbar-nav navbar-right">
        <li><span class="glyphicon glyphicon-log-out"></span><br /><button type="button" id="odjava" class="btn btn-success"> Odjava</button></li>
			</ul>
		</div>
	</nav>
  <div class="table-responsive">
      <p id="tbl"></p>
  </div>
  <script type="text/javascript" scr="app.js"></script>
    <script type="text/javascript">
      console.log("Na stranici rezultati.html");
      //dohvacanje potrebnih podataka iz localStorage
      var username = localStorage.getItem("username");
      var pass = localStorage.getItem("pass");
      var ime = localStorage.getItem("ime");
      var prezime = localStorage.getItem("prezime");
      var id = localStorage.getItem("id_prijave");
      var objectStore = null;
      var bodovi = [];
      var elts = 0;
      //polje za podatke koji se nalaze u prvom retku tablice sa rezultatima
      var td_kategorije = ["Kolegij", "1.kolokvij ", "2.kolokvij", "Završni ispit", "1.zadaća", "2.zadaća", "3.zadaća", "4.zadaća"];
      $(document).ready(function(){
        $("#podaci").append(" " + ime + " " + prezime);
        if(navigator.onLine) {
          console.log("online sam");
          notifikacijeOnline();
          push_subscribe();
          $("#podaci").append(" (online)").css("color", "#5cb85c");
          $.ajax({
            url: "rezultati.php",
            data:
            {
              id: id
            },
            dataType: "json",
            success: function(data) {
              //online smo -> tablica se crta sa podacima iz ajax poziva
              if(data.rez.length !== 0) {
                //dok smo u online modu, podatke dobivene ajax upitom spremamo u indexedDB kako bismo ih mogli dohvatiti i u offline modu
                var request = window.indexedDB.open("Studenti", 1);
                request.onsuccess = function(event) {
                  var db = event.target.result;
                  var objectStore = db.transaction("rezultati", "readwrite").objectStore("rezultati");
                  var index = objectStore.index("id_studenta");
                  var count = index.count();
                  count.onsuccess = function() {
                    //console.log("count "+count.result);
                    br = count.result;
                    for(var i = 0; i <data.rez.length; i++) {
                      //console.log("id "+id);
                      objectStore.put({id: (id+i), id_studenta: id, kolegij: data.rez[i].ime, kol1: data.rez[i].kol1, kol2: data.rez[i].kol2,
                             zavrsni: data.rez[i].zavrsni, dz1: data.rez[i].dz1, dz2: data.rez[i].dz2, dz3: data.rez[i].dz3, dz4: data.rez[i].dz4});
                      //console.log("Ubacio rez");
                    }
                  }
                };
                //crtanje tablice sa podacima dobivenima iz ajax poziva
                var tbl = $("<table></table>");
                tbl.prop("class", "table");
                //prvi redak tablice
                var tr = $("<tr></tr>");
                for(var i = 0; i < data.rez.length; i++) {
                  var td_podrucja = [data.rez[i].ime, data.rez[i].kol1, data.rez[i].kol2, data.rez[i].zavrsni, data.rez[i].dz1, data.rez[i].dz2, data.rez[i].dz3, data.rez[i].dz4];
                  //var tr = $("<tr></tr>");
                  if(i === 0) {
                    var td = $("<td></td>");
                    td.prop("align", "center").html(td_kategorije[0]);
                    var td1 = $("<td></td>");
                    td1.prop("align", "center").html(td_podrucja[0]);
                    tr.append(td);
                    tr.append(td1);
                  }
                  else {
                    var td = $("<td></td>");
                    td.prop("align", "center").html(td_podrucja[0]);
                    tr.append(td);
                  }
                tbl.append(tr);
                }
                for(var j = 0; j < 7; j++) {
                  var tr = $("<tr></tr>");
                  var td = $("<td></td>");
                  td.prop("align", "center").html(td_kategorije[j+1]);
                  tr.append(td);
                  for(var i = 0; i < data.rez.length; i++) {
                    var td_podrucja = [data.rez[i].ime, data.rez[i].kol1, data.rez[i].kol2, data.rez[i].zavrsni, data.rez[i].dz1, data.rez[i].dz2, data.rez[i].dz3, data.rez[i].dz4];
                    var td = $("<td></td>");
                    if(td_podrucja[j+1] === null)
                      td.prop("align", "center").html("-");
                    else
                      td.prop("align", "center").html(td_podrucja[j+1]);
                    tr.append(td);
                  }
                  tbl.append(tr);
                }
                $("#tbl").append(tbl);
                console.log("Nacrtao tablicu, izlazim iz fje.");
                //ispisiRezultate(data.rez);
              }
              else
                $("#tbl").append("Niste upisali niti jedan kolegij!");
            },
            error : function(xhr, status) {
              if(status !== "null")
              console.log("Nesto nije u redu s Ajax upitom. Status: " + status + ".");
            }
          });
        }
        else {
          notifikacijeOffline();
          console.log("offline sam");
          $("#podaci").append(" (offline)").css("color", "red");
          $("span").css("color", "red");
          $("h2").css("color", "red");
          ispisiRezultateOffline();
        }
      });
      function notifikacijeOnline() {
        //obavijest o otvaranju aplikacije
        console.log("notifikacije");
        if("Notification" in window && "serviceWorker" in navigator) {
          Notification.requestPermission().then(function(premission) {
            if(premission === "granted") {
              console.log("granted");
              navigator.serviceWorker.ready.then(function(registration) {
                registration.showNotification("Prijava u aplikaciju", {
                  body: ime +" "+prezime+" "+"upravo ste se prijavili u aplikaciju za praćenje svojih rezultata na ispitima.",
                  icon: "4.jpg",
                  tag: "novi-login"
                });
              });
            }
          });
        }
      }
      function notifikacijeOffline() {
        //obavijest o otvaranju aplikacije
        console.log("notifikacije");
        if("Notification" in window && "serviceWorker" in navigator) {
          Notification.requestPermission().then(function(premission) {
            if(premission === "granted") {
              console.log("granted");
              navigator.serviceWorker.ready.then(function(registration) {
                registration.showNotification("Prijava u aplikaciju", {
                  body: ime +" "+prezime+" "+"upravo ste se prijavili u aplikaciju za praćenje svojih rezultata na ispitima. Upozorenje: možda Vam se ne prikazuju najnoviji rezultati. Prijavite se u aplikaciju kada ćete imati pristup internetu za dohvat najnovijih rezultata!",
                  icon: "4.jpg",
                  tag: "novi-login"
                });
              });
            }
          });
        }
      }
      function push_subscribe() {
        return checkNotificationPermission()
          .then(() => navigator.serviceWorker.ready)
          .then(serviceWorkerRegistration =>
            serviceWorkerRegistration.pushManager.subscribe({
              userVisibleOnly: true,
              applicationServerKey: urlBase64ToUint8Array("BLSWJLWJM_MK-VdIJ4f2LcTLs9PPHnvehQu-iQ9nKGgh04RRV2LMbCsCiO28F4yJb4CSKqB2YMwhFUlWDDaWT14"),
            })
          )
          .then(subscription => {
              // Subscription was successful
              // create subscription on your server
              return push_sendSubscriptionToServer(subscription, 'POST');
            // Subscription was successful
            // create subscription on your server
            //return push_sendSubscriptionToServer(subscription, 'POST');
          });
      }
        function checkNotificationPermission() {
          return new Promise((resolve, reject) => {
            if (Notification.permission === 'denied') {
              return reject(new Error('Push messages are blocked.'));
            }

            if (Notification.permission === 'granted') {
              console.log("g");
              return resolve();
            }

            if (Notification.permission === 'default') {
              return Notification.requestPermission().then(result => {
                if (result !== 'granted') {
                  reject(new Error('Bad permission result'));
                }

                resolve();
              });
            }
          });
        }

        function urlBase64ToUint8Array(base64String) {
          const padding = '='.repeat((4 - (base64String.length % 4)) % 4);
          const base64 = (base64String + padding).replace(/\-/g, '+').replace(/_/g, '/');

          const rawData = window.atob(base64);
          const outputArray = new Uint8Array(rawData.length);

          for (let i = 0; i < rawData.length; ++i) {
            outputArray[i] = rawData.charCodeAt(i);
          }
          return outputArray;
        }

        function push_sendSubscriptionToServer(subscription, method) {
          const key = subscription.getKey('p256dh');
          const token = subscription.getKey('auth');
          const contentEncoding = (PushManager.supportedContentEncodings || ['aesgcm'])[0];
          console.log('Received PushSubscription: ', JSON.stringify(subscription))
          var endpoint = subscription.endpoint;
          var publicKey = key ? btoa(String.fromCharCode.apply(null, new Uint8Array(key))) : null;
          var authToken = token ? btoa(String.fromCharCode.apply(null, new Uint8Array(token))) : null;
          return fetch('rezultati.php', {
            method,
            body: JSON.stringify({
              endpoint: subscription.endpoint,
              publicKey: key ? btoa(String.fromCharCode.apply(null, new Uint8Array(key))) : null,
              authToken: token ? btoa(String.fromCharCode.apply(null, new Uint8Array(token))) : null,
              contentEncoding,
            }),
          }).then(() => subscription);
        }
      //fja za dinamičko stvaranje tablice sa rezultatima
      function ispisiRezultateOffline() {
        console.log("U fji ispisiRezultateOffline");
        var imaRez = false;
        var request = window.indexedDB.open("Studenti", 1);
        request.onsuccess = function(event) {
          var db = event.target.result;
          var objectStore = db.transaction("rezultati", "readonly").objectStore("rezultati");
          var index = objectStore.index("id_studenta");
          //var count = index.count();
          var cursor = index.openCursor(id);
          var tbl = $("<table></table>");
          tbl.prop("id", "tblRez");
          var tr = $("<tr></tr>");
          //potrebno je 8 ćelija sa nazivima elemenata za ocjenjivanje
          for(var k = 0; k < 8 ; k++) {
            var td = $("<td></td>");
            td.prop("align", "center").html(td_kategorije[k]);
            tr.append(td);
          }
          tbl.append(tr);
          cursor.onsuccess = function(event) {
            var cursor = event.target.result;
            if (cursor) {
              imaRez = true;
              var td_podrucja = [cursor.value.kolegij, cursor.value.kol1, cursor.value.kol2, cursor.value.zavrsni, cursor.value.dz1, cursor.value.dz2, cursor.value.dz3, cursor.value.dz4];
              var tr = $("<tr></tr>");
              for(var j = 0; j < 8; j++) {
                var td = $("<td></td>");
                if(td_podrucja[j] === null)
                  td.prop("align", "center").html("-");
                else
                  td.prop("align", "center").html(td_podrucja[j]);
                tr.append(td);
              }
              tbl.append(tr);
              cursor.continue();
            }
            else {
              console.log("Gotovo");
            }
            if(!imaRez)
              $("#tbl").html("Niste upisali niti jedan kolegij!");
            else
              $("#tbl").append(tbl);
          };
        };
      }
      $("#odjava").on("click", function() {
        window.location.href = "index.html";
        localStorage.clear();
      });
    </script>

  </body>
</html>
